        # 本打包来自这个仓库，微修改：https://github.com/mymine/CatVodSpider
name: Spider4
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '18'
        distribution: 'temurin'
     
    - name: Delete workflows
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 2
     
    - name: Clone projects
      run: |
        # 主项目：lushunming/AndroidCatVodSpider
        git clone --recurse-submodules https://github.com/lushunming/AndroidCatVodSpider project
        sed -i 's/mirrors.cloud.tencent.com\gradle/services.gradle.org\/distributions/g' project/gradle/wrapper/gradle-wrapper.properties
        cp -r ./project/json/index.json ./json/index.json
      
        # 额外项目：dlgt6/CatVodSpider（用于添加指定爬虫 + 最新的 Vod.java）
        git clone https://github.com/dlgt6/CatVodSpider extra_project
      
        # ========== 复制指定的 spider 类到主项目 ==========
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/Douban.java project/app/src/main/java/com/github/catvod/spider/ || echo "Douban.java not found or already exists"
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/Duanju2.java project/app/src/main/java/com/github/catvod/spider/ || echo "Duanju2.java not found"
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/HMDJ.java project/app/src/main/java/com/github/catvod/spider/ || echo "HMDJ.java not found"
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/Hanju99.java project/app/src/main/java/com/github/catvod/spider/ || echo "Hanju99.java not found"
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/Qimao.java project/app/src/main/java/com/github/catvod/spider/ || echo "Qimao.java not found"
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/Rydj.java project/app/src/main/java/com/github/catvod/spider/ || echo "Rydj.java not found"
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/TianQuan.java project/app/src/main/java/com/github/catvod/spider/ || echo "TianQuan.java not found"
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/Ting39.java project/app/src/main/java/com/github/catvod/spider/ || echo "Ting39.java not found"
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/WuCg.java project/app/src/main/java/com/github/catvod/spider/ || echo "WuCg.java not found"
        cp -v extra_project/app/src/main/java/com/github/catvod/spider/Xqdd.java project/app/src/main/java/com/github/catvod/spider/ || echo "Xqdd.java not found"
      
        # ========== 关键修改：使用 dlgt6 的最新 Vod.java 替换主项目的旧版 ==========
        mkdir -p project/app/src/main/java/com/github/catvod/bean
        cp -v extra_project/app/src/main/java/com/github/catvod/bean/Vod.java project/app/src/main/java/com/github/catvod/bean/Vod.java || echo "Vod.java not found in dlgt6 repo"
        echo "Successfully replaced Vod.java with the latest version from dlgt6/CatVodSpider"
     
    - name: Customize Spider
      working-directory: ./project
      run: |
         # 删除垃圾爬虫（保持你原来的删除列表）
         #rm -rf app/src/main/java/com/github/catvod/spider/Ali.java
         rm -rf app/src/main/java/com/github/catvod/spider/Dm84.java
         rm -rf app/src/main/java/com/github/catvod/spider/Doll.java
         rm -rf app/src/main/java/com/github/catvod/spider/Eighteen.java
         rm -rf app/src/main/java/com/github/catvod/spider/Hanime.java
         rm -rf app/src/main/java/com/github/catvod/spider/JSDemo.java
         rm -rf app/src/main/java/com/github/catvod/spider/Jable.java
         rm -rf app/src/main/java/com/github/catvod/spider/Jianpian.java
         rm -rf app/src/main/java/com/github/catvod/spider/Kanqiu.java
         rm -rf app/src/main/java/com/github/catvod/spider/Miss.java
         rm -rf app/src/main/java/com/github/catvod/spider/Notice.java
         #rm -rf app/src/main/java/com/github/catvod/spider/PanSearch.java
         #rm -rf app/src/main/java/com/github/catvod/spider/PanSou.java
         rm -rf app/src/main/java/com/github/catvod/spider/Star.java
         #rm -rf app/src/main/java/com/github/catvod/spider/UpYun.java
         rm -rf app/src/main/java/com/github/catvod/spider/Wogg.java
         rm -rf app/src/main/java/com/github/catvod/spider/XiaoZhiTiao.java
         rm -rf app/src/main/java/com/github/catvod/spider/YiSo.java
         #rm -rf app/src/main/java/com/github/catvod/spider/Ysj.java
         rm -rf app/src/main/java/com/github/catvod/spider/Zhaozy.java
       
         # 删除 Doll 残留 + 彻底移除 Wogg 相关调试代码（防止编译错误）
         sed -i "/Doll/d" app/src/main/java/com/github/catvod/debug/MainActivity.java
         sed -i "/Wogg/d" app/src/main/java/com/github/catvod/debug/MainActivity.java
       
    - name: Build the Jar
      working-directory: ./project
      run: |
         chmod +x gradlew
         ./gradlew assemblerelease --build-cache --parallel --daemon --warning-mode all
      
    - name: Customize Spider Jar
      working-directory: ./project
      run: |
         rm -rf jar/custom_spider.jar
         rm -rf jar/spider.jar/original/META-INF
         curl -L https://github.com/iBotPeaches/Apktool/releases/download/v2.7.0/apktool_2.7.0.jar > jar/3rd/apktool_2.7.0.jar
         java -jar jar/3rd/baksmali-2.5.2.jar d app/build/intermediates/dex/release/minifyReleaseWithR8/classes.dex -o jar/Smali_classes
         mkdir -p jar/spider.jar/smali/com/github/catvod/
         mv jar/Smali_classes/com/github/catvod/spider jar/spider.jar/smali/com/github/catvod/
         java -jar jar/3rd/apktool_2.7.0.jar b jar/spider.jar -c
         mv jar/spider.jar/dist/dex.jar ../jar/custom_spider.jar
         echo $(md5sum ../jar/custom_spider.jar | awk '{print $1}') > ../jar/custom_spider.jar.md5
      
    - name: Update spider jar
      uses: EndBug/add-and-commit@v9.1.3
      with:
        default_author: github_actions
        message: 'update spider'
        add: "['./jar/custom_spider.jar', './jar/custom_spider.jar.md5', './json/index.json']"
     
    - name: Upload Spider
      uses: actions/upload-artifact@main
      with:
        name: Spider
        path: ./jar/custom_spider.jar
